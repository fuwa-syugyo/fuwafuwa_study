## Chapter 06

### セッション

クライアントとサーバーでのステートフルな一連の通信のこと。
HTTPは当初の設計思想によりステートレス(状態を持たない=リクエストの関係性がわからない)な通信である。
つまり、通信を識別することができない。
(ちなみにステータスフルな通信の例としてはFTPがある。)

そのためWebアプリケーションではセッションのように通信を識別する方法を別途作成する必要がある。

### クッキー

HTTPサーバがクライアントにレスポンスを返すときに付加する情報のこと。
クライアントはクッキーを保存し、次に同じサーバにリクエストを送信するとき、同じクッキーをリクエストに追加してサーバに送信する。

最も一般的な使い方はクライアントの識別。
サーバがクライアントからのリクエストを最初に受け取ったとき、クライアントを識別する情報を発行する。
その識別情報を参照して、どのクライアントからのリクエストなのか把握できる。
発行元と同じサーバにアクセスしたときに、クライアントはクッキーを送信する。

クッキーはクライアントにキーバリュー形式で保存されている。
保存方法は特に決まっておらず、発行元のサーバごとにクッキーを分けて保存している。
サーバがクライアントに情報を渡すときはHTTPレスポンスの`Set-Cookie`ヘッダに格納される。

#### クッキーの属性

「発行元と同じサーバにアクセスしたときに、クライアントはクッキーを送信する」というのが基本的な考え方だが、細かな条件がある。
HTTPレスポンスの`Set-Cookie`ヘッダによってクッキーが渡されるが、ここに属性が付加される。
長いので詳細は省くが、概ね以下のように指定すると良いらしい。

* `Domain`属性
クッキーを受け取ったクライアントがどのサーバに対してアクセスしたときにクッキーを送信すべきか指定する。
基本的に未指定。クッキーを生成したドメインだけに送信されるようにする。

* `Path`属性
クッキーを受け取ったクライアントが、Domain属性で指定したサーバのどのパスに対してアクセスしたときにクッキーを送信すべきか指定する。
Domain属性は基本的に未指定なので、これも未指定？

* `Secure`属性
暗号化されたHTTPS通信のときだけクッキーを送信するように指定する。
これは指定しましょう。

* `HttpOnly`属性
未指定だとブラウザで保存しているクッキーはブラウザ上で動作するJavaScriptから読み書きできてしまうので、クロスサイトスクリプティングなどの危険性がある。
これは指定しましょう。

* `SameSite`属性
ブラウザからのクッキーの送信条件をより厳密に制限する。(詳細は難しいらしい)
可能な限り`Lax`or`Strict`を指定。クッキーを発行したドメインとは異なるオリジンのHTMLやJavaScriptからのリクエストにおいてクッキー送信を制限する。

### クッキーを利用したクライアントの識別

これまでの流れをまとめると、クッキーを利用してサーバが生成した任意の情報をクライアントに保存できる。
つまり、クライアントの識別ができる。ここではクライアントを識別する文字列を`セッションID`と呼ぶことにする。

初回アクセス時、クライアント→サーバ通信のときはクッキーは送信されず、サーバは初めてアクセスしたクライアントと判断する。
サーバはセッションIDを発行し、レスポンスのSet-Cookieヘッダに載せてクライアントに渡す。
アプリケーション(サーバに該当するのか？)はセッションIDに対応するアイテムを作って内部で管理する。(この本だとToDoアプリなのでToDoリストのこと)
セッションIDに紐づいて保存されるデータを`セッション情報`と呼ぶ。

以降、クライアントがセッションIDをリクエストのクッキーに載せて送信する際に、それに対応するデータを返したり変更したりする。

### セッションハイジャック

他人のセッションIDを把握し、セッションを乗っ取ってしまうこと。
セッションIDの推測、登用、固定化がその手法。

推測を防ぐために、セッションIDを連番で発行したり、メアドなどユーザー情報を含ませたりすることはやめましょう。

登用は暗号化されていない通信の傍受、クロスサイトスクリプティングなどでクッキーを盗み出す方法が知られている。
かつてセッションIDをクエリパラメータとして受け渡しする手法があったが、これはやめましょう。クッキーでやりとりしましょう。
加えて、httpsによる暗号化通信と、クッキーにsecure属性を付与しましょう。

固定化は、攻撃者があらかじめ取得したセッションIDを何らかの方法で被害者のブラウザに送り込んで使用させる手法。
最近のウェブサイトでは最初にアクセスしたときに未ログインでもセッションIDを発行することが多いらしい。
固定化を防ぐために、ログイン後にセッションIDを変更することと、一定間隔でセッションIDを変更することが推奨されている。

### サードパーティクッキー

そのへんのウェブサイトにアクセスしたときに表示される「このサイトはCookieを使っています」的なアレ。
いろんなサイトに入っている広告サイトのクッキーで、使用者の興味のあるものを把握し、それに関する広告を表示するために使われている。
(なんか気持ち悪いなーと思ったらブラウザでブロックできます)
さっきまで説明していたクッキーはWebアプリケーションに必要なもので、ファーストパーティクッキーと呼ばれ、別物である。
